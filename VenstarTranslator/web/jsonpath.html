<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venstar Sensor Emulator</title>

    <!-- External Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet" />
    <link href="style.css" rel="stylesheet" />

    <style>
        .large-textarea {
            height: 400px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        #json-document {
            height: 488px;
        }

        #url-selector-container:not([style*="display: none"]) ~ label + #json-document {
            height: 400px;
        }

        #result-textarea {
            height: 488px;
            background-color: #f1f5f9;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-list"></i>
                </div>
                <h2 class="card-title">JSON Path Tester (JSON.Net Syntax)</h2>
                <div class="card-actions">
                    <button class="btn btn-secondary" onclick="window.close()">
                        <i class="fas fa-backward"></i> Back to Sensor Config
                    </button>
                </div>
            </div>

            <div class="row g-3 mb-3 align-items-end">
                <div class="col">
                    <label for="query" class="form-label">JSON Path Query</label>
                    <input type="text" id="query" class="form-control" placeholder="e.g., $.store.book[0].title" required>
                </div>
                <div class="col-auto">
                    <button class="btn btn-success" onclick="testJsonPath()">
                        <i class="fa-brands fa-js me-1"></i> Test JSON Path
                    </button>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <div id="url-selector-container" class="mb-3" style="display: none;">
                        <label for="url-selector" class="form-label">Document Source</label>
                        <select id="url-selector" class="form-select">
                            <option value="">Use Document Below</option>
                        </select>
                    </div>
                    <label for="json-document" class="form-label fw-semibold">JSON Document</label>
                    <textarea id="json-document" class="form-control large-textarea" placeholder="Enter your JSON document here..."></textarea>
                </div>
                <div class="col-md-6">
                    <label for="result-textarea" class="form-label fw-semibold">Result</label>
                    <textarea id="result-textarea" class="form-control large-textarea" placeholder="Results will appear here..." readonly></textarea>
                </div>
            </div>

        </div>
    </div>

    <script>
        let sensors = [];

        // Load sensors on page load
        $(function() {
            loadSensors();
        });

        function loadSensors() {
            $.ajax({
                url: '/api/sensors',
                type: 'GET',
                success: function(response) {
                    sensors = response;
                    populateUrlSelector();
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load sensors:', error);
                }
            });
        }

        function populateUrlSelector() {
            const selector = $('#url-selector');
            const container = $('#url-selector-container');

            // Clear existing options except the first one
            selector.find('option:not(:first)').remove();

            if (sensors.length === 0) {
                container.hide();
                return;
            }

            // Group sensors by URL
            const urlMap = new Map();
            sensors.forEach(sensor => {
                if (!urlMap.has(sensor.url)) {
                    urlMap.set(sensor.url, []);
                }
                urlMap.get(sensor.url).push(sensor.sensorID);
            });

            // Add options for each unique URL
            urlMap.forEach((sensorIds, url) => {
                const idsStr = sensorIds.join(', ');
                const displayText = `Sensor ${idsStr} - ${url}`;
                selector.append($('<option>', {
                    value: url,
                    text: displayText
                }));
            });

            container.show();
        }

        // Handle URL selector change
        $('#url-selector').on('change', function() {
            const selectedUrl = $(this).val();
            const jsonDocument = $('#json-document');

            if (selectedUrl) {
                // Disable textarea and fetch data from URL
                jsonDocument.prop('disabled', true);
                jsonDocument.val('Loading...');

                $.ajax({
                    url: '/api/fetchurl',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ url: selectedUrl }),
                    dataType: 'text', // Expect text response, not JSON
                    success: function(response) {
                        // Format the JSON for display
                        try {
                            const parsed = JSON.parse(response);
                            jsonDocument.val(JSON.stringify(parsed, null, 2));
                        } catch (e) {
                            // If it's not valid JSON, just display as-is
                            jsonDocument.val(response);
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = 'Failed to fetch URL content: ' + error;
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            try {
                                const errorObj = JSON.parse(xhr.responseText);
                                if (errorObj.message) {
                                    errorMessage = errorObj.message;
                                }
                            } catch (e) {
                                // Ignore parse error
                            }
                        }
                        jsonDocument.val(errorMessage);
                        jsonDocument.prop('disabled', false);
                    }
                });
            } else {
                // Enable textarea for manual input
                jsonDocument.prop('disabled', false);
                jsonDocument.val('');
            }
        });

        function testJsonPath() {
            const query = document.getElementById('query').value.trim();
            const jsonDocument = document.getElementById('json-document').value.trim();
            const resultTextarea = document.getElementById('result-textarea');

            // Clear previous results
            resultTextarea.value = '';

            // Validate inputs
            if (!query) {
                resultTextarea.value = 'Error: JSON Path Query is required.';
                return;
            }

            if (!jsonDocument) {
                resultTextarea.value = 'Error: JSON Document is required.';
                return;
            }

            // Show loading state
            resultTextarea.value = 'Testing JSON Path...';

            // Prepare data for POST request
            const requestData = {
                query: query,
                jsonDocument: jsonDocument
            };

            // Make the HTTP POST request
            $.ajax({
                url: '/api/testjsonpath',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                success: function (response) {
                    // Handle successful response - extract Message property
                    if (response && response.message) {
                        resultTextarea.value = response.message;
                    } else if (typeof response === 'string') {
                        resultTextarea.value = response;
                    } else {
                        resultTextarea.value = JSON.stringify(response, null, 2);
                    }
                },
                error: function (xhr, status, error) {
                    // Handle error response - extract Message property
                    let errorMessage = '';

                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            if (errorResponse.message) {
                                errorMessage = errorResponse.message;
                            } else {
                                errorMessage = JSON.stringify(errorResponse, null, 2);
                            }
                        } catch (e) {
                            errorMessage = xhr.responseText;
                        }
                    } else {
                        errorMessage = `HTTP ${xhr.status} - ${error}`;
                    }

                    resultTextarea.value = errorMessage;
                },
                complete: function () {
                    // This runs regardless of success or error
                    console.log('JSON Path test completed');
                }
            });
        }

        // Allow Enter key to trigger test in the query input
        document.getElementById('query').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                testJsonPath();
            }
        });
    </script>

</body>

</html>